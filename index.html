<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tasks</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #1e1e1e);
            color: var(--tg-theme-text-color, #fff);
            font-family: sans-serif; margin: 0; padding: 15px; padding-bottom: 80px;
        }
        /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .task-card {
            background: var(--tg-theme-secondary-bg-color, #2d2d2d);
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid #3390ec;
        }
        .task-card.backlog { border-left-color: #888; opacity: 0.7; }
        .task-info div:first-child { font-weight: bold; margin-bottom: 5px; }
        .task-info div:last-child { font-size: 12px; opacity: 0.7; }
        
        .btn-check {
            width: 30px; height: 30px; border: 2px solid #50fa7b; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #50fa7b; cursor: pointer;
        }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: var(--tg-theme-secondary-bg-color, #2d2d2d);
            display: flex; border-top: 1px solid #444; z-index: 99;
        }
        .tab { flex: 1; display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; }
        .tab.active { color: #3390ec; background: rgba(255,255,255,0.05); }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { display: none; }
        .page.active { display: block; }

        /* –§–æ—Ä–º–∞ */
        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px;
            border: 1px solid #444; background: #333; color: #fff; box-sizing: border-box;
        }
        .btn-main {
            width: 100%; padding: 15px; background: #3390ec; color: #fff; border: none;
            border-radius: 10px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –°–ü–ò–°–û–ö -->
    <div id="view-list" class="page active">
        <h2 style="margin-top:0">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
        <div id="list-container">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –°–û–ó–î–ê–¢–¨ -->
    <div id="view-create" class="page">
        <h2 style="margin-top:0">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
        
        <label>–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏</label>
        <input type="text" id="inp-task" placeholder="–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ">
        
        <label>–°—Ä–æ–∫</label>
        <select id="inp-dead">
            <option value="–°–µ–≥–æ–¥–Ω—è">–°–µ–≥–æ–¥–Ω—è</option>
            <option value="–ó–∞–≤—Ç—Ä–∞">–ó–∞–≤—Ç—Ä–∞</option>
            <option value="–°—Ä–æ—á–Ω–æ">üî• –°—Ä–æ—á–Ω–æ</option>
        </select>

        <label>–¢–∞–π–º–µ—Ä (—á–∏—Å–ª–æ + –º/—á)</label>
        <div style="display:flex; gap:10px;">
            <input type="number" id="inp-time" placeholder="0">
            <select id="inp-unit" style="width:80px;">
                <option value="60">–º–∏–Ω</option>
                <option value="3600">—á–∞—Å</option>
            </select>
        </div>

        <div style="margin-bottom: 20px; display: flex; align-items: center;">
            <input type="checkbox" id="inp-backlog" style="width: 20px; height: 20px; margin: 0 10px 0 0;">
            <label for="inp-backlog" style="margin:0">–í –±—ç–∫–ª–æ–≥</label>
        </div>

        <button class="btn-main" onclick="sendCreate()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="tabs">
        <div class="tab active" onclick="nav('view-list', this)">üìã –°–ø–∏—Å–æ–∫</div>
        <div class="tab" onclick="nav('view-create', this)">‚ûï –°–æ–∑–¥–∞—Ç—å</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ß—Ç–µ–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ —Å—Å—ã–ª–∫–∏)
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const raw = params.get('data'); // –ë–æ—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä ?data=...
            
            const container = document.getElementById('list-container');
            container.innerHTML = "";

            if (!raw) {
                container.innerHTML = "<p style='text-align:center; color:#777'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –Ω–æ–≤–æ–µ –º–µ–Ω—é)</p>";
                return;
            }

            try {
                const tasks = JSON.parse(decodeURIComponent(raw));
                
                if (tasks.length === 0) {
                    container.innerHTML = "<p style='text-align:center; color:#777'>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚ú®</p>";
                    return;
                }

                tasks.forEach(t => {
                    let div = document.createElement('div');
                    div.className = `task-card ${t.is_backlog ? 'backlog' : ''}`;
                    
                    let icon = t.is_backlog ? 'üì¶' : 'üìå';
                    
                    div.innerHTML = `
                        <div class="task-info">
                            <div>${icon} ${t.task_text}</div>
                            <div>‚è∞ ${t.deadline}</div>
                        </div>
                        <div class="btn-check" onclick="sendClose(${t.id})">‚úî</div>
                    `;
                    container.appendChild(div);
                });

            } catch (e) {
                container.innerHTML = "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö";
            }
        };

        // 2. –û—Ç–ø—Ä–∞–≤–∫–∞ "–°–æ–∑–¥–∞—Ç—å"
        function sendCreate() {
            const task = document.getElementById('inp-task').value;
            if(!task) return tg.showAlert("–í–≤–µ–¥–∏ –∑–∞–¥–∞—á—É!");

            const timeVal = document.getElementById('inp-time').value;
            const timeUnit = document.getElementById('inp-unit').value;
            let totalSec = 0;
            if (timeVal > 0) totalSec = timeVal * timeUnit;

            const data = {
                action: 'create',
                task: task,
                deadline: document.getElementById('inp-dead').value,
                is_backlog: document.getElementById('inp-backlog').checked ? 1 : 0,
                reminder_sec: totalSec
            };
            tg.sendData(JSON.stringify(data));
        }

        // 3. –û—Ç–ø—Ä–∞–≤–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å"
        function sendClose(id) {
            if(confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É?")) {
                tg.sendData(JSON.stringify({ action: 'close', id: id }));
            }
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function nav(viewId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(t => t.classList.rem
