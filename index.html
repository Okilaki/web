<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #1e1e1e);
            --text: var(--tg-theme-text-color, #fff);
            --secondary: var(--tg-theme-secondary-bg-color, #2b2b2b);
            --btn: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #fff);
            --green: #50fa7b;
        }
        body { margin: 0; padding: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        
        /* –¢–∞–±—ã */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--secondary); height: 60px;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #333; z-index: 100;
        }
        .tab-btn {
            flex: 1; text-align: center; font-size: 12px; color: #888; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;
        }
        .tab-btn.active { color: var(--btn); }
        .tab-icon { font-size: 20px; margin-bottom: 3px; }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { display: none; padding: 20px; animation: fade 0.2s; }
        .page.active { display: block; }

        h2 { margin-top: 0; }
        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: var(--secondary); border: 1px solid #444;
            color: var(--text); border-radius: 8px; box-sizing: border-box; outline: none;
        }
        .btn-main {
            width: 100%; padding: 14px; background: var(--btn); color: var(--btn-text);
            border: none; border-radius: 10px; font-weight: bold; cursor: pointer;
        }

        /* –°–ø–∏—Å–æ–∫ */
        .task-item {
            background: var(--secondary); padding: 15px; margin-bottom: 10px;
            border-radius: 10px; border-left: 4px solid var(--btn);
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-title { font-weight: bold; font-size: 16px; }
        .task-meta { font-size: 12px; color: #aaa; margin-top: 4px; }
        .btn-done {
            background: transparent; border: 2px solid var(--green); color: var(--green);
            border-radius: 50%; width: 32px; height: 32px; cursor: pointer; margin-left: 10px;
            display: flex; align-items: center; justify-content: center;
        }

        /* –ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞ */
        .reminder-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px; border-radius: 8px; margin-bottom: 15px;
        }
        .flex-row { display: flex; gap: 10px; }

        @keyframes fade { from {opacity: 0;} to {opacity: 1;} }
    </style>
</head>
<body>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ -->
    <div id="p-create" class="page active">
        <h2>‚ú® –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
        
        <label>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?</label>
        <textarea id="t_text" rows="3" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏..."></textarea>
        
        <label>–°—Ä–æ–∫</label>
        <select id="t_dead">
            <option value="–°–µ–≥–æ–¥–Ω—è">üìÖ –°–µ–≥–æ–¥–Ω—è</option>
            <option value="–ó–∞–≤—Ç—Ä–∞">üå§ –ó–∞–≤—Ç—Ä–∞</option>
            <option value="–°—Ä–æ—á–Ω–æ">üî• –°—Ä–æ—á–Ω–æ</option>
            <option value="–ë–µ–∑ —Å—Ä–æ–∫–∞">‚ôæ –ë–µ–∑ —Å—Ä–æ–∫–∞</option>
        </select>

        <div class="reminder-box">
            <label>üîî –ù–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
            <div class="flex-row">
                <input type="number" id="remind_val" placeholder="0">
                <select id="remind_unit" style="width: 80px;">
                    <option value="m">–º–∏–Ω</option>
                    <option value="h">—á–∞—Å</option>
                    <option value="d">–¥–Ω–µ–π</option>
                </select>
            </div>
            <div style="font-size: 12px; color: #888;">–û—Å—Ç–∞–≤—å 0 –∏–ª–∏ –ø—É—Å—Ç–æ, –µ—Å–ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ.</div>
        </div>

        <button class="btn-main" onclick="createTask()">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –°–ø–∏—Å–æ–∫ -->
    <div id="p-list" class="page">
        <h2>üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
        <div id="task-container">
            <p style="text-align:center; color:#666;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <!-- –ú–µ–Ω—é -->
    <div class="tab-bar">
        <div class="tab-btn active" onclick="switchTab('p-create', this)">
            <div class="tab-icon">‚ûï</div> –°–æ–∑–¥–∞—Ç—å
        </div>
        <div class="tab-btn" onclick="switchTab('p-list', this)">
            <div class="tab-icon">üìã</div> –°–ø–∏—Å–æ–∫
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const rawData = urlParams.get('tasks');
            if (rawData) {
                try {
                    const tasks = JSON.parse(decodeURIComponent(rawData));
                    renderTasks(tasks);
                } catch (e) { document.getElementById('task-container').innerHTML = "–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö"; }
            } else {
                document.getElementById('task-container').innerHTML = "<p style='text-align:center'>–ù–µ—Ç –∑–∞–¥–∞—á</p>";
            }
        };

        function renderTasks(tasks) {
            const container = document.getElementById('task-container');
            container.innerHTML = "";
            if (tasks.length === 0) {
                container.innerHTML = "<p style='text-align:center'>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç üå¥</p>";
                return;
            }
            tasks.forEach(t => {
                if (t.is_backlog == 0) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
                    let div = document.createElement('div');
                    div.className = 'task-item';
                    div.innerHTML = `
                        <div class="task-info">
                            <div class="task-title">${t.task_text}</div>
                            <div class="task-meta">‚è∞ ${t.deadline}</div>
                        </div>
                        <div class="btn-done" onclick="completeTask(${t.id})">‚úî</div>
                    `;
                    container.appendChild(div);
                }
            });
        }

        function createTask() {
            const text = document.getElementById('t_text').value;
            const dead = document.getElementById('t_dead').value;
            
            // –î–∞–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            const rVal = document.getElementById('remind_val').value;
            const rUnit = document.getElementById('remind_unit').value;
            
            if (!text) return tg.showAlert("–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç!");

            const data = {
                action: 'create',
                task: text,
                deadline: dead,
                // –ï—Å–ª–∏ –≤–≤–µ–ª–∏ —á–∏—Å–ª–æ, –ø–µ—Ä–µ–¥–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                reminder: (rVal && rVal > 0) ? rVal + rUnit : null 
            };
            tg.sendData(JSON.stringify(data));
        }

        function completeTask(id) {
            if(!confirm("–ó–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É?")) return;
            tg.sendData(JSON.stringify({ action: 'close', task_id: id }));
        }

        function switchTab(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
</body>
</html>
