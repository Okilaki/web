<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #1e1e1e);
            --text: var(--tg-theme-text-color, #fff);
            --secondary: var(--tg-theme-secondary-bg-color, #2b2b2b);
            --btn: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #fff);
            --green: #50fa7b; --red: #ff5555;
        }
        body { margin: 0; padding: 20px; font-family: sans-serif; background: var(--bg); color: var(--text); padding-bottom: 90px; }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* –¢–∞–±—ã */
        .tab-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(43, 43, 43, 0.9); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 10px 20px; display: flex; gap: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid #444; z-index: 100;
        }
        .tab-btn {
            color: #888; font-size: 24px; cursor: pointer; transition: 0.2s;
            padding: 5px 10px; border-radius: 10px;
        }
        .tab-btn.active { color: var(--btn); background: rgba(255,255,255,0.05); }

        /* –ü–æ–ª—è */
        h2 { margin-top: 0; font-size: 20px; }
        label { font-size: 13px; color: #aaa; margin-bottom: 5px; display: block; }
        
        input, select, textarea {
            width: 100%; padding: 14px; margin-bottom: 15px;
            background: var(--secondary); border: 1px solid #3f3f3f;
            color: var(--text); border-radius: 12px; box-sizing: border-box; outline: none; font-size: 16px;
        }
        textarea { resize: none; font-family: sans-serif; }
        input:focus, select:focus, textarea:focus { border-color: var(--btn); }

        /* –ö–Ω–æ–ø–∫–∞ */
        .btn-main {
            width: 100%; padding: 16px; background: var(--btn); color: var(--btn-text);
            border: none; border-radius: 14px; font-weight: bold; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(51, 144, 236, 0.3);
        }
        .btn-main:active { transform: scale(0.98); }

        /* –ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞ (–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è) */
        .timer-row {
            display: flex; align-items: center; gap: 10px; background: var(--secondary);
            padding: 10px; border-radius: 12px; border: 1px solid #3f3f3f; margin-bottom: 15px;
        }
        .timer-icon { font-size: 20px; }
        .timer-input { margin: 0; border: none; background: transparent; padding: 5px; text-align: right;}

        /* –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á */
        .task-item {
            background: var(--secondary); padding: 16px; margin-bottom: 12px;
            border-radius: 14px; border-left: 5px solid var(--btn);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .task-item.backlog { border-left-color: #aaa; opacity: 0.8; }
        
        .task-main { flex: 1; }
        .task-text { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .task-sub { font-size: 12px; color: #888; display: flex; gap: 10px; }
        
        .btn-done {
            width: 36px; height: 36px; border-radius: 50%;
            border: 2px solid var(--green); color: var(--green);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; margin-left: 10px;
        }

        .page { display: none; animation: slide 0.3s; }
        .page.active { display: block; }
        @keyframes slide { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
    </style>
</head>
<body>

    <!-- –°–¢–†–ê–ù–ò–¶–ê: –°–û–ó–î–ê–¢–¨ -->
    <div id="p-create" class="page active">
        <h2>‚ú® –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
        
        <label>–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?</label>
        <textarea id="t_text" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç..."></textarea>
        
        <label>–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
        <select id="t_dead">
            <option value="–°–µ–≥–æ–¥–Ω—è">üìÖ –°–µ–≥–æ–¥–Ω—è</option>
            <option value="–ó–∞–≤—Ç—Ä–∞">üå§ –ó–∞–≤—Ç—Ä–∞</option>
            <option value="–°—Ä–æ—á–Ω–æ">üî• –°—Ä–æ—á–Ω–æ</option>
            <option value="–ë–µ–∑ —Å—Ä–æ–∫–∞">‚ôæ –ë–µ–∑ —Å—Ä–æ–∫–∞</option>
        </select>

        <!-- –¢–∞–π–º–µ—Ä –≤–Ω—É—Ç—Ä–∏ –∑–∞–¥–∞—á–∏ -->
        <label>üîî –¢–∞–π–º–µ—Ä / –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</label>
        <div class="timer-row">
            <div class="timer-icon">‚è∞</div>
            <input type="number" id="r_val" placeholder="0" class="timer-input">
            <select id="r_unit" style="width: 80px; margin: 0; border: none; background: #333;">
                <option value="m">–º–∏–Ω</option>
                <option value="h">—á–∞—Å</option>
                <option value="d">–¥–Ω.</option>
            </select>
        </div>

        <!-- –ì–∞–ª–∫–∞ –ë—ç–∫–ª–æ–≥ -->
        <div style="display: flex; align-items: center; margin-bottom: 20px; cursor: pointer;" onclick="document.getElementById('t_back').click()">
            <input type="checkbox" id="t_back" style="width: 20px; height: 20px; margin: 0 10px 0 0;">
            <span style="font-size: 14px;">üì¶ –ó–∞–∫–∏–Ω—É—Ç—å –≤ –ë—ç–∫–ª–æ–≥ (—Å–¥–µ–ª–∞—Ç—å –ø–æ—Ç–æ–º)</span>
        </div>

        <button class="btn-main" onclick="createTask()">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>

    <!-- –°–¢–†–ê–ù–ò–¶–ê: –°–ü–ò–°–û–ö -->
    <div id="p-list" class="page">
        <h2>üìã –ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
        <div id="list-container">
            <p style="text-align: center; color: #666; margin-top: 50px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ (–ü–ª–∞–≤–∞—é—â–µ–µ) -->
    <div class="tab-bar">
        <div class="tab-btn active" onclick="nav('p-create', this)">‚ûï</div>
        <div class="tab-btn" onclick="nav('p-list', this)">üìã</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –ß–∏—Ç–∞–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ URL
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const raw = params.get('tasks');
            if(raw) {
                try {
                    const tasks = JSON.parse(decodeURIComponent(raw));
                    render(tasks);
                } catch(e) { document.getElementById('list-container').innerHTML = "–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö"; }
            } else {
                document.getElementById('list-container').innerHTML = "<p style='text-align:center'>–ü—É—Å—Ç–æ</p>";
            }
        };

        function render(tasks) {
            const box = document.getElementById('list-container');
            box.innerHTML = "";
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ, –ø–æ—Ç–æ–º –±—ç–∫–ª–æ–≥
            tasks.sort((a,b) => a.is_backlog - b.is_backlog);

            if(tasks.length === 0) {
                box.innerHTML = "<p style='text-align:center; color: #666;'>–ù–µ—Ç –∑–∞–¥–∞—á üå¥</p>";
                return;
            }

            tasks.forEach(t => {
                let div = document.createElement('div');
                div.className = `task-item ${t.is_backlog ? 'backlog' : ''}`;
                
                let icon = t.is_backlog ? 'üì¶' : 'üìå';
                if(t.deadline.includes("–°—Ä–æ—á–Ω–æ")) icon = 'üî•';

                div.innerHTML = `
                    <div class="task-main">
                        <div class="task-text">${icon} ${t.task_text}</div>
                        <div class="task-sub">
                            <span>üìÖ ${t.deadline}</span>
                        </div>
                    </div>
                    <div class="btn-done" onclick="closeTask(${t.id})">‚úî</div>
                `;
                box.appendChild(div);
            });
        }

        function createTask() {
            let txt = document.getElementById('t_text').value;
            let dead = document.getElementById('t_dead').value;
            let back = document.getElementById('t_back').checked ? 1 : 0;
            let rVal = document.getElementById('r_val').value;
            let rUnit = document.getElementById('r_unit').value;

            if(!txt) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏!");

            // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫—É
            let reminder = (rVal && rVal > 0) ? rVal + rUnit : null;

            let data = {
                action: 'create',
                task: txt,
                deadline: dead,
                is_backlog: back,
                reminder: reminder
            };
            tg.sendData(JSON.stringify(data));
        }

        function closeTask(id) {
            if(confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É?")) {
                tg.sendData(JSON.stringify({ action: 'close', id: id }));
            }
        }

        function nav(id, btn) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
</body>
</html>
