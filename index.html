<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #1e1e1e);
            --text: var(--tg-theme-text-color, #fff);
            --secondary: var(--tg-theme-secondary-bg-color, #2b2b2b);
            --btn: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #fff);
            --red: #ff5555;
            --green: #50fa7b;
        }
        body { margin: 0; padding: 0; font-family: sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; }
        
        /* –¢–∞–±—ã (–ú–µ–Ω—é —Å–Ω–∏–∑—É) */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--secondary); height: 60px;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #333; z-index: 100;
        }
        .tab-btn {
            flex: 1; text-align: center; font-size: 12px; color: #888; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;
        }
        .tab-btn.active { color: var(--btn); }
        .tab-icon { font-size: 20px; margin-bottom: 3px; }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
        .page { display: none; padding: 20px; animation: fade 0.2s; }
        .page.active { display: block; }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º */
        h2 { margin-top: 0; }
        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 15px;
            background: var(--secondary); border: 1px solid #444;
            color: var(--text); border-radius: 8px; box-sizing: border-box; outline: none;
        }
        .btn-main {
            width: 100%; padding: 14px; background: var(--btn); color: var(--btn-text);
            border: none; border-radius: 10px; font-weight: bold; cursor: pointer;
        }

        /* –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á */
        .task-list { list-style: none; padding: 0; margin: 0; }
        .task-item {
            background: var(--secondary); padding: 15px; margin-bottom: 10px;
            border-radius: 10px; border-left: 4px solid var(--btn);
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-info { flex: 1; }
        .task-title { font-weight: bold; font-size: 16px; }
        .task-meta { font-size: 12px; color: #aaa; margin-top: 4px; }
        
        .btn-done {
            background: transparent; border: 2px solid var(--green); color: var(--green);
            border-radius: 50%; width: 32px; height: 32px; cursor: pointer; margin-left: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .btn-done:active { background: var(--green); color: #000; }

        /* –ß–µ–∫–±–æ–∫—Å –ë—ç–∫–ª–æ–≥ */
        .checkbox-wrapper { display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;}
        .checkbox-wrapper input { width: auto; margin: 0 10px 0 0; }

        @keyframes fade { from {opacity: 0;} to {opacity: 1;} }
    </style>
</head>
<body>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ -->
    <div id="p-create" class="page active">
        <h2>‚ú® –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
        
        <label>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?</label>
        <textarea id="t_text" rows="3" placeholder="–¢–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏..."></textarea>
        
        <label>–°—Ä–æ–∫</label>
        <select id="t_dead">
            <option value="–°–µ–≥–æ–¥–Ω—è">üìÖ –°–µ–≥–æ–¥–Ω—è</option>
            <option value="–ó–∞–≤—Ç—Ä–∞">üå§ –ó–∞–≤—Ç—Ä–∞</option>
            <option value="–°—Ä–æ—á–Ω–æ">üî• –°—Ä–æ—á–Ω–æ</option>
        </select>

        <label class="checkbox-wrapper">
            <input type="checkbox" id="t_backlog">
            <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –ë—ç–∫–ª–æ–≥ (–Ω–∞ –ø–æ—Ç–æ–º)</span>
        </label>

        <button class="btn-main" onclick="sendAction('create')">–°–æ–∑–¥–∞—Ç—å</button>

        <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">

        <h2>‚è∞ –ë—ã—Å—Ç—Ä—ã–π —Ç–∞–π–º–µ—Ä</h2>
        <input type="text" id="r_text" placeholder="–û —á–µ–º –Ω–∞–ø–æ–º–Ω–∏—Ç—å?">
        <div style="display: flex; gap: 10px;">
            <input type="number" id="r_time" placeholder="–ß–∏—Å–ª–æ">
            <select id="r_unit" style="width: 80px;">
                <option value="m">–º–∏–Ω</option>
                <option value="h">—á–∞—Å</option>
            </select>
        </div>
        <button class="btn-main" style="background: #e67e22;" onclick="sendAction('remind')">–ó–∞–≤–µ—Å—Ç–∏ —Ç–∞–π–º–µ—Ä</button>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –ú–æ–∏ –ó–∞–¥–∞—á–∏ -->
    <div id="p-list" class="page">
        <h2>üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
        <div id="task-container" class="task-list">
            <!-- –°—é–¥–∞ –ø–æ–ø–∞–¥—É—Ç –∑–∞–¥–∞—á–∏ –∏–∑ Python -->
            <p style="color: #666; text-align: center; margin-top: 50px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <!-- –ú–µ–Ω—é -->
    <div class="tab-bar">
        <div class="tab-btn active" onclick="switchTab('p-create', this)">
            <div class="tab-icon">‚ûï</div> –°–æ–∑–¥–∞—Ç—å
        </div>
        <div class="tab-btn" onclick="switchTab('p-list', this)">
            <div class="tab-icon">üìã</div> –ó–∞–¥–∞—á–∏
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        // –ë–æ—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä ?data=JSON
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const rawData = urlParams.get('tasks');
            
            if (rawData) {
                try {
                    const tasks = JSON.parse(decodeURIComponent(rawData));
                    renderTasks(tasks);
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∑–∞–¥–∞—á", e);
                    document.getElementById('task-container').innerHTML = "<p>–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</p>";
                }
            } else {
                document.getElementById('task-container').innerHTML = "<p style='text-align:center'>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</p>";
            }
        };

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á
        function renderTasks(tasks) {
            const container = document.getElementById('task-container');
            container.innerHTML = ""; // –û—á–∏—Å—Ç–∏—Ç—å

            if (tasks.length === 0) {
                container.innerHTML = "<p style='text-align:center'>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç üå¥</p>";
                return;
            }

            tasks.forEach(t => {
                // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–µ –∏–∑ –±—ç–∫–ª–æ–≥–∞
                if (t.is_backlog == 0) {
                    let div = document.createElement('div');
                    div.className = 'task-item';
                    div.innerHTML = `
                        <div class="task-info">
                            <div class="task-title">${t.task_text}</div>
                            <div class="task-meta">‚è∞ ${t.deadline}</div>
                        </div>
                        <div class="btn-done" onclick="completeTask(${t.id})">‚úî</div>
                    `;
                    container.appendChild(div);
                }
            });
        }

        // 2. –û–¢–ü–†–ê–í–ö–ê –î–ï–ô–°–¢–í–ò–ô
        function sendAction(type) {
            let data = {};

            if (type === 'create') {
                const text = document.getElementById('t_text').value;
                if (!text) return tg.showAlert("–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç!");
                
                data = {
                    action: 'create',
                    task: text,
                    deadline: document.getElementById('t_dead').value,
                    is_backlog: document.getElementById('t_backlog').checked ? 1 : 0
                };
            } 
            else if (type === 'remind') {
                const text = document.getElementById('r_text').value;
                const val = document.getElementById('r_time').value;
                const unit = document.getElementById('r_unit').value;
                
                if (!text || !val) return tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏ —Ç–∞–π–º–µ—Ä!");
                
                data = {
                    action: 'remind',
                    text: text,
                    time_str: val + unit
                };
            }

            tg.sendData(JSON.stringify(data));
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ –∫–ª–∏–∫—É
        function completeTask(id) {
            if(!confirm("–ó–∞–∫—Ä—ã—Ç—å –∑–∞–¥–∞—á—É?")) return;
            
            const data = {
                action: 'close',
                task_id: id
            };
            tg.sendData(JSON.stringify(data));
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
            event.target.closest('.task-item').style.opacity = '0.5';
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        function switchTab(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
</body>
</html>
